# Logging

SRouter emphasizes structured, intelligent logging, primarily using the [zap](https://github.com/uber-go/zap) library. A `*zap.Logger` instance is highly recommended in the `RouterConfig`. If not provided, SRouter will attempt to create a default production logger (or a no-op logger if creation fails). All internal logging performed by the router utilizes this logger instance.

## Structured Logging

Using a structured logger like zap allows for:

-   **Machine-Readable Logs**: Logs are typically output in formats like JSON, making them easy to parse, index, and query by log aggregation systems (e.g., ELK stack, Splunk, Datadog).
-   **Contextual Information**: Key-value pairs (fields) can be added to log entries, providing rich context (e.g., `trace_id`, `user_id`, `http_method`, `status_code`).
-   **Performance**: Zap is designed for high performance and low allocation overhead compared to standard library logging or reflection-based approaches.

## Log Levels

SRouter's internal components use appropriate log levels:

-   **`Error`**: Used for significant server-side problems, unrecoverable errors, panics caught by recovery middleware, failures during critical operations (like server shutdown). Status codes 500+ often trigger Error logs.
-   **`Warn`**: Used for client-side errors (status codes 400-499), potentially problematic situations (e.g., rate limit exceeded, configuration issues), or notable but non-critical events (e.g., slow request warnings if implemented).
-   **`Info`**: Used sparingly for high-level operational information (e.g., server starting, shutting down gracefully). Avoid spamming Info logs in the request path.
-   **`Debug`**: Used for detailed diagnostic information useful during development or troubleshooting. This includes detailed request/response metrics (status, duration, bytes, IP, trace ID - logged internally when trace logging is enabled via `TraceIDBufferSize > 0`), context values, trace information, and fine-grained steps within components. The main request trace log can also be set to Debug via `TraceLoggingUseInfo: false`.

This tiered approach helps manage log verbosity. In production, you typically configure your logger to output `Info` level and above, while `Debug` logs are suppressed unless needed for debugging.

## Configuring the Logger

You provide the `*zap.Logger` instance in `RouterConfig`. You can configure this logger according to your environment's needs.

```go
import "go.uber.org/zap"
import "go.uber.org/zap/zapcore" // Import for zapcore
import "log" // Import standard log package

// Production Logger Example: JSON format, Info level and above
logger, err := zap.NewProduction()
if err != nil {
    log.Fatalf("can't initialize zap logger: %v", err)
}
defer logger.Sync() // Flushes buffer, if any

// Development Logger Example: Human-readable console format, Debug level and above
devLogger, err := zap.NewDevelopment()
if err != nil {
    log.Fatalf("can't initialize zap logger: %v", err)
}
defer devLogger.Sync()

// Custom Logger Example: Info level, add caller info
config := zap.NewProductionConfig()
config.Level = zap.NewAtomicLevelAt(zap.InfoLevel)
config.EncoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder // Example time format
customLogger, err := config.Build(zap.AddCaller()) // Add caller info (file:line)
if err != nil {
    log.Fatalf("can't initialize zap logger: %v", err)
}
defer customLogger.Sync()


// Pass the chosen logger to SRouter
routerConfig := router.RouterConfig{
    Logger: logger, // Use the production logger instance
    // ... other config
}
```

Refer to the [zap documentation](https://pkg.go.dev/go.uber.org/zap) for detailed configuration options.

## Trace ID Integration

When [Trace ID Logging](./trace-logging.md) is enabled (via `TraceIDBufferSize > 0` in `RouterConfig`), SRouter's internal logging (request/response summary, errors, timeouts, panics) automatically includes the `trace_id` field in its log entries. You should also include the `trace_id` in logs generated by your own handlers and middleware for consistent request tracing across your application and services.

```go
// Within a handler or middleware where logger is available:
// Assuming UserIDType=string, UserObjectType=MyUserType
// traceID := scontext.GetTraceIDFromRequest[string, MyUserType](r)
// userID, _ := scontext.GetUserIDFromRequest[string, MyUserType](r)

logger.Info("Processing user data",
    zap.String("trace_id", traceID), // Include trace ID
    zap.String("user_id", userID),   // Include user ID
    // ... other relevant fields
)
```

## Request Summary Logging

When `TraceIDBufferSize` is set to a value greater than zero, SRouter emits a single log entry at the end of every request. The message is `"Request summary statistics"` and includes fields:

- `method` and `path`
- HTTP `status`
- request `duration`
- number of `bytes` written
- client `ip` and `user_agent`
- `trace_id` when trace IDs are enabled

The log level is selected automatically:

- `Error` for status codes `>= 500`
- `Warn` for status codes `>= 400` or requests taking longer than 500&nbsp;ms
- `Info` for successful requests when `TraceLoggingUseInfo` is `true`
- `Debug` otherwise

Setting `TraceIDBufferSize` to `0` disables this automatic summary log.
